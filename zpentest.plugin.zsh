########## Plugin: zpentest ##########
# ----------------------------------------#
########## Author: Doc0x1 ##########
########## Version: 1.11 ##########
# ----------------------------------------#
########## github.com/Doc0x1 ##########
# ----------------------------------------#

#$ To make pentests easier, this plugin will set persistent environment variables for LHOST and RHOST
penteston() {
    # Determine the location of .zshrc
    ZSHRC_LOCATION="${ZDOTDIR:-$HOME}/.zshrc"

    # Check if .zshrc exists
    if [ ! -f "$ZSHRC_LOCATION" ]; then
        printf "Error: .zshrc not found at $ZSHRC_LOCATION. Please create it first.\n"
        return 1
    fi

    # Initialize variables
    local LHOST=''
    local RHOST=''

    # Regex pattern for validating IP address
    local ip_regex='^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$'

    # Process arguments
    while [[ "$#" -gt 0 ]]; do
        case $1 in
            --lhost)
                LHOST=$2
                shift 2
                ;;
            --rhost)
                RHOST=$2
                shift 2
                ;;
            *)
                printf "This function will set persistent environment variables for LHOST and RHOST.\n"
                printf "Usage: penteston --lhost <local_ip> --rhost <remote_ip>\n"
                return 1
                ;;
        esac
    done

    # Validate and set RHOST
    if [[ -n "$RHOST" && "$RHOST" =~ $ip_regex ]]; then
        export RHOST=$RHOST
        if grep -q 'export RHOST=' "$ZSHRC_LOCATION"; then
            sed -i "s/export RHOST=.*/export RHOST=$RHOST/" "$ZSHRC_LOCATION"
        else
            echo "export RHOST=$RHOST" >>"$ZSHRC_LOCATION"
        fi
        printf "Setting RHOST variable to $RHOST\n"
    else
        printf "Error: Invalid RHOST IP address format.\n"
        return 1
    fi

    # Validate and set LHOST
    if [[ -n "$LHOST" && "$LHOST" =~ $ip_regex ]]; then
        export LHOST=$LHOST
        if grep -q 'export LHOST=' "$ZSHRC_LOCATION"; then
            sed -i "s/export LHOST=.*/export LHOST=$LHOST/" "$ZSHRC_LOCATION"
        else
            echo "export LHOST=$LHOST" >>"$ZSHRC_LOCATION"
        fi
        printf "Setting LHOST variable to $LHOST\n"
    else
        printf "Error: Invalid LHOST IP address format.\n"
        return 1
    fi
}

#$ Use this function when done with the pentest.
pentestoff() {
    # Determine the location of .zshrc
    ZSHRC_LOCATION="${ZDOTDIR:-$HOME}/.zshrc"

    # Check if .zshrc exists
    if [ ! -f "$ZSHRC_LOCATION" ]; then
        printf "Error: .zshrc not found at $ZSHRC_LOCATION.\n"
        return 1
    fi

    printf "This function will unset the LHOST and RHOST variables and remove them from $ZSHRC_LOCATION.\n"
    printf "Use it when you are finished pentesting.\n"

    # Unset variables and remove from .zshrc
    unset LHOST RHOST
    sed -i '/export LHOST=/d' "$ZSHRC_LOCATION"
    sed -i '/export RHOST=/d' "$ZSHRC_LOCATION"
    printf "Unset LHOST and RHOST variables and removed them from $ZSHRC_LOCATION\n"
}
